version: 1.0.0
# Next iteration of ACR Tasks, which support cmd, and build as first class objects
steps:
  - id: build-HelloWorld
    build: |
      -t {{.Build.Registry}}/helloworld:{{.Build.ID}} 
      -t {{.Build.Registry}}/helloworld:release 
      .
    when: ['-']

  - id: build-HelloWorld-Test
    build: -t helloworldTest .
    when: ['-']

  - id: funcTests
    cmd: {{.Build.Registry}}/helloworld:{{.Build.ID}}
    cmd: build-HelloWorld-Test
    when: ['build-HelloWorld', 'build-HelloWorld-Test']

  - cmd: docker push {{.Build.Registry}}/helloworld:{{.Build.ID}}
    when: ['funcTests']

  - cmd: docker push {{.Build.Registry}}/helloworld:release
    when: ['funcTests']

  - cmd: |
      {{.Build.Registry}}/functions/helm 
      upgrade helloworld ./helm/helloworld/ 
      --reuse-values 
      --set helloworld.image=demo42.azurecr.io/helloworld:{{.Build.ID}}
