version: v1.1.0
steps:
  - id: build-hello-world
    when: [-]
    build: >
      -f ./Dockerfile
      -t $Registry/demo42/helloworld:$ID
      .
  - id: az-login
    # login with the identity of the task
    when: [-]
    cmd: >
      az login --identity -o jsonc > /dev/null
  - id: push-images
    # Push images, after they're built
    when: ['build-hello-world']
    push: 
    - "$Registry/demo42/helloworld:$ID"
  - id: aks-get-credentials
    # Get AKS credentials to initiate a helm deploy
    # This step is dependent on the az-login step, 
    # which is running concurrently with the build
    when: ['az-login']
    cmd: >
      az aks get-credentials 
      -n demo42-dev
      -g demo42-dev-scus
  - id: helm-deploy
    # Once the images are built, and we have credentials
    # coalesce the parallel build steps to do the helm upgrade
    when: ['push-images', 'aks-get-credentials']
    cmd: >
      demo42upstream.azurecr.io/mcr/acr/helm:v3 upgrade 
      helloworld ./charts/helloworld/ 
      --reuse-values 
      --set helloworld.image=$Registry/demo42/helloworld:$ID
