version: 1.0-preview-1
steps:
  - build: >
      -t {{.Run.Registry}}/hello-world:{{.Run.ID}}
      -t {{.Run.Registry}}/hello-world:latest
      -f ./Dockerfile 
      --build-arg REGISTRY_NAME={{.Run.Registry}}/ 
      .
  - id: hello-world
    cmd: {{.Run.Registry}}/hello-world:{{.Run.ID}}
    detach: true
  - cmd: cmd.azurecr-test.io/curl --url http://hello-world
  - push: 
    - {{.Run.Registry}}/hello-world:{{.Run.ID}}
    - {{.Run.Registry}}/hello-world:latest
  - cmd: >
      cmd.azurecr-test.io/helm:v2.11.0-rc.2 
    entryPoint: "./deploy.sh"
    env:
      - TENANT={{.Values.TENANT}}
      - SP={{.Values.SP}}
      - PASSWORD={{.Values.PASSWORD}}
      - CLUSTER_RESOURCE_GROUP={{.Values.CLUSTER_RESOURCE_GROUP}}
      - CLUSTER_NAME={{.Values.CLUSTER_NAME}}
      - ACR_NAME=demo42
      - APP_NAME=helloworld
      - RUN_ID={{.Run.ID}}
      - RUN_REGISTRY={{.Run.Registry}}
