version: v1.1.0
alias:
  values:
    teleport : "orca run --mount type=bind,options=rbind:rw,source=/var/lib/docker/volumes/{{.Run.SharedVolume}}/_data,destination=/workspace --cwd /workspace"
steps:
  - id: build-hello-world
    when: [-]
    build: >
      -f ./Dockerfile
      -t $Registry/demo42/helloworld:$ID
      .
  - id: az-login
    # login with the identity of the task
    when: [-]
    cmd: >
      az login --identity -o jsonc > /dev/null
  - id: push-images
    # Push images, after they're built
    when: ['build-hello-world']
    push: 
    - "$Registry/demo42/helloworld:$ID"
  - id: aks-get-credentials
    # Get AKS credentials to initiate a helm deploy
    # This step is dependent on the az-login step, 
    # which is running concurrently with the build
    when: ['az-login']
    cmd: >
      $teleport az aks get-credentials 
      -n demo42-dev
      -g demo42-dev-scus
  - id: helm-deploy
    # Once the images are built, and we have credentials
    # coalesce the parallel build steps to do the helm upgrade
    when: ['push-images', 'aks-get-credentials']
    cmd: >
      $teleport $Registry/base-artifacts/acr/helm helm upgrade 
      helloworld ./charts/helloworld/ 
      --reuse-values 
      --set helloworld.image=$Registry/demo42/helloworld:$ID
  - id: lock-tag
    # Block the ability to update this tag (immutable)
    # Block the ability to delete the image - because it was deployed
    when: ['az-login', 'push-images']
    cmd: >
      az acr repository update 
      --name $RegistryName
      --image demo42/helloworld:$ID
      --write-enabled false
      --delete-enabled false 
