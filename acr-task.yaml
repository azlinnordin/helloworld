version: v1.1.0
alias:
  values:
    az: mcr.microsoft.com/acr/acr-cli:0.1
steps:
  - id: build-hello-world
    build: >
      -t $Registry/demo42/helloworld:$ID
      -f ./Dockerfile
      .
    #cache: enabled
  - id: push-images
    push: 
    - "$Registry/demo42/helloworld:$ID"
    - id: az-login
    cmd: >
      az login --identity -o jsonc > /dev/null
    # login with the identity of the task
  - id: aks-get-credentials
    cmd: >
      az aks get-credentials 
      -n demo42-dev
      -g demo42-dev-scus
  - id: helm-deploy
    cmd: >
      demo42upstream.azurecr.io/mcr/acr/helm:v3 upgrade helloworld ./charts/helloworld/ --reuse-values --set helloworld.image=$Registry/demo42/helloworld:$ID
