version: v1.1.0
steps:
  - id: build-hello-world
    build: >
      -f ./Dockerfile
      -t $Registry/demo42/helloworld:$ID
      .
  - id: push-images
    # Push images, after they're built
    push: 
    - "$Registry/demo42/helloworld:$ID"
  - id: get-kube-config
    cmd: bash echo $KUBE_CONFIG > ~/kube.config
    env:
      - KUBE_CONFIG="{{ .Values.KUBE_CONFIG }}"
  - cmd: bash ls ~/kube.config
  - cmd: bash cat ~/kube.config
  - id: helm-deploy
    # Once the images are built, and we have credentials
    # coalesce the parallel build steps to do the helm upgrade
    cmd: >
      demo42upstream.azurecr.io/mcr/acr/helm:v3 upgrade 
      helloworld ./charts/helloworld/ 
      --kubeconfig ~/kube.config
      --reuse-values 
      --set helloworld.image=$Registry/demo42/helloworld:$ID

